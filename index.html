<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Marda Loop Bakery Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; transition: background 0.3s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .item-card:active { transform: scale(0.96); }
        .modal { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(100%); }
        .modal.active { transform: translateY(0); }
        .shimmer { background: linear-gradient(90deg, #f3f4f6 0%, #ffffff 50%, #f3f4f6 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .confetti { position: absolute; pointer-events: none; }
    </style>
</head>
<body class="bg-[#FBFBFD] text-[#1D1D1F] pb-32 overflow-x-hidden">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-xl p-5 shadow-sm sticky top-0 z-50 rounded-b-[2.5rem] flex justify-between items-center">
        <div>
            <h1 class="text-xs font-black text-orange-500 tracking-[0.2em] uppercase mb-1">Marda Loop</h1>
            <h2 class="text-xl font-bold leading-tight">Bakery & Pro</h2>
        </div>
        <div id="weather-hub" class="flex flex-col items-end">
            <div class="flex items-center space-x-1 shimmer rounded-full px-2 py-1" id="temp-container">
                <span id="current-temp" class="text-sm font-bold">--Â°C</span>
            </div>
            <span id="loc-status" class="text-[8px] text-gray-400 font-bold uppercase mt-1">Locating...</span>
        </div>
    </header>

    <!-- Menu Section -->
    <main class="p-4" id="main-view">
        <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-6" id="category-scroller">
            <!-- JS Categories -->
        </div>
        
        <div class="grid grid-cols-2 gap-4" id="menu-grid">
            <!-- JS Items -->
        </div>
    </main>

    <!-- Cart Modal Overlay -->
    <div id="modal-bg" class="fixed inset-0 bg-black/40 z-[60] hidden opacity-0 transition-opacity duration-300"></div>
    <div id="cart-modal" class="fixed inset-x-0 bottom-0 bg-white rounded-t-[3rem] z-[70] modal p-6 shadow-[0_-20px_40px_rgba(0,0,0,0.1)] max-h-[85vh] overflow-y-auto no-scrollbar">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <h2 class="text-2xl font-extrabold mb-6 flex items-center">Your Bag <span id="modal-count" class="ml-2 text-sm bg-orange-100 text-orange-500 px-3 py-1 rounded-full">0</span></h2>
        
        <div id="cart-items-list" class="space-y-4 mb-8">
            <!-- JS Cart Items -->
        </div>

        <div class="border-t border-gray-100 pt-6 space-y-3">
            <div class="flex justify-between text-gray-500 font-medium"><span>Subtotal</span><span id="sub-price">$0.00</span></div>
            <div class="flex justify-between text-gray-500 font-medium italic"><span>GST (5%)</span><span id="tax-price">$0.00</span></div>
            <div class="flex justify-between items-end pt-2">
                <span class="font-black text-xl">Total</span>
                <span id="final-price" class="text-2xl font-black text-orange-500">$0.00</span>
            </div>
        </div>

        <button onclick="processOrder()" id="pay-btn" class="w-full bg-[#1D1D1F] text-white py-5 rounded-[2rem] mt-8 font-bold text-lg flex justify-center items-center space-x-3 active:scale-[0.98] transition-transform">
            <span>Pay & Order</span>
            <i class="fas fa-arrow-right text-sm"></i>
        </button>
    </div>

    <!-- Sticky Floating Cart -->
    <div id="floating-cart" class="fixed bottom-6 inset-x-4 bg-[#1D1D1F] text-white p-4 rounded-[2rem] flex justify-between items-center hidden z-40 animate-bounce-short">
        <div class="flex items-center space-x-4 cursor-pointer" onclick="toggleCart(true)">
            <div class="relative bg-white text-black h-12 w-12 rounded-2xl flex items-center justify-center">
                <i class="fas fa-shopping-bag text-lg"></i>
                <span id="float-count" class="absolute -top-1 -right-1 bg-orange-500 text-white text-[10px] font-bold h-5 w-5 rounded-full flex items-center justify-center">0</span>
            </div>
            <div>
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">In your bag</p>
                <p id="float-total" class="font-bold text-lg">$0.00</p>
            </div>
        </div>
        <button onclick="toggleCart(true)" class="bg-white/10 px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-tighter hover:bg-white/20">View Order</button>
    </div>

    <script>
        const API_KEY_BRAVE = "BSA898N8pw3lApwK6AuuIUDLbfgWgzs";
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const menu = [
            { id: 1, name: "Gold Croissant", price: 4.50, cat: "pastry", img: "https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=400" },
            { id: 2, name: "YYC Iced Latte", price: 5.75, cat: "drinks", img: "https://images.unsplash.com/photo-1517701604599-bb29b565090c?w=400" },
            { id: 3, name: "Almond Pain", price: 5.00, cat: "pastry", img: "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=400" },
            { id: 4, name: "Flat White", price: 4.25, cat: "drinks", img: "https://images.unsplash.com/photo-1577968897966-3d4325b36b61?w=400" },
            { id: 5, name: "Marda Sandwich", price: 12.50, cat: "lunch", img: "https://images.unsplash.com/photo-1528735602780-2552fd46c7af?w=400" },
            { id: 6, name: "Avocado Toast", price: 10.99, cat: "lunch", img: "https://images.unsplash.com/photo-1525351484163-7529414344d8?w=400" }
        ];

        let cart = {};

        // ðŸŒ¡ï¸ REAL-TIME WEATHER
        async function fetchWeather(lat, lon) {
            const status = document.getElementById('loc-status');
            const tempEl = document.getElementById('current-temp');
            try {
                const response = await fetch(`https://api.search.brave.com/res/v1/web/search?q=weather+at+${lat},${lon}+celsius`, {
                    headers: { 'X-Subscription-Token': API_KEY_BRAVE, 'Accept': 'application/json' }
                });
                const data = await response.json();
                const snippet = data.web.results[0].description;
                const tempMatch = snippet.match(/(-?\d+)Â°/);
                if (tempMatch) {
                    tempEl.innerText = tempMatch[0] + "C";
                    document.getElementById('temp-container').classList.remove('shimmer');
                    status.innerText = "Current Weather";
                }
            } catch (e) { status.innerText = "Weather Unavailable"; }
        }

        navigator.geolocation.getCurrentPosition(
            p => fetchWeather(p.coords.latitude, p.coords.longitude),
            _ => { 
                document.getElementById('current-temp').innerText = "+12Â°C"; 
                document.getElementById('loc-status').innerText = "Calgary Default";
                document.getElementById('temp-container').classList.remove('shimmer');
            }
        );

        // ðŸ›’ CART LOGIC
        function toggleCart(show) {
            const modal = document.getElementById('cart-modal');
            const bg = document.getElementById('modal-bg');
            if(show) {
                renderCart();
                modal.classList.add('active');
                bg.classList.remove('hidden');
                setTimeout(() => bg.style.opacity = "1", 10);
            } else {
                modal.classList.remove('active');
                bg.style.opacity = "0";
                setTimeout(() => bg.classList.add('hidden'), 300);
            }
        }

        document.getElementById('modal-bg').onclick = () => toggleCart(false);

        function changeQty(id, delta) {
            cart[id] = (cart[id] || 0) + delta;
            if (cart[id] <= 0) delete cart[id];
            updateApp();
            renderCart();
            tg.HapticFeedback.impactOccurred('light');
        }

        function updateApp() {
            const count = Object.values(cart).reduce((a,b) => a+b, 0);
            const subtotal = Object.keys(cart).reduce((acc, id) => acc + (menu.find(m => m.id == id).price * cart[id]), 0);
            
            document.getElementById('float-count').innerText = count;
            document.getElementById('float-total').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('floating-cart').classList.toggle('hidden', count === 0);
        }

        function renderCart() {
            const list = document.getElementById('cart-items-list');
            const count = Object.values(cart).reduce((a,b) => a+b, 0);
            const subtotal = Object.keys(cart).reduce((acc, id) => acc + (menu.find(m => m.id == id).price * cart[id]), 0);
            const gst = subtotal * 0.05;

            document.getElementById('modal-count').innerText = count;
            document.getElementById('sub-price').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax-price').innerText = `$${gst.toFixed(2)}`;
            document.getElementById('final-price').innerText = `$${(subtotal + gst).toFixed(2)}`;

            list.innerHTML = Object.keys(cart).map(id => {
                const item = menu.find(m => m.id == id);
                return `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl">
                        <div class="flex items-center space-x-4">
                            <img src="${item.img}" class="h-12 w-12 rounded-xl object-cover">
                            <div><p class="font-bold text-sm">${item.name}</p><p class="text-xs text-orange-500">$${item.price.toFixed(2)}</p></div>
                        </div>
                        <div class="flex items-center space-x-3 bg-white px-3 py-1 rounded-xl border border-gray-100">
                            <button onclick="changeQty(${id}, -1)" class="text-orange-500 p-1"><i class="fas fa-minus"></i></button>
                            <span class="font-bold w-4 text-center">${cart[id]}</span>
                            <button onclick="changeQty(${id}, 1)" class="text-orange-500 p-1"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = menu.map(item => `
                <div class="item-card bg-white rounded-[2rem] p-3 shadow-sm border border-gray-50 relative">
                    <img src="${item.img}" class="h-32 w-full object-cover rounded-[1.5rem] mb-3" alt="${item.name}">
                    <h3 class="font-bold text-xs uppercase tracking-tight mb-1 truncate px-1">${item.name}</h3>
                    <div class="flex justify-between items-center px-1">
                        <span class="font-black text-sm">$${item.price.toFixed(2)}</span>
                        <button onclick="changeQty(${item.id}, 1)" class="bg-orange-500 text-white h-7 w-7 rounded-full text-[10px] active:bg-black transition-colors"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function processOrder() {
            const btn = document.getElementById('pay-btn');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> <span>Processing...</span>';
            tg.HapticFeedback.notificationOccurred('success');
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check"></i> <span>Paid Successfully</span>';
                btn.classList.replace('bg-[#1D1D1F]', 'bg-green-500');
                tg.sendData(JSON.stringify({cart, total: document.getElementById('final-price').innerText}));
                setTimeout(() => tg.close(), 1500);
            }, 2000);
        }

        renderMenu();
    </script>
</body>
</html>
