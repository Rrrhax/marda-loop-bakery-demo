<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Marda Loop Bakery Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .item-card:active { transform: scale(0.96); }
        .modal { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(100%); visibility: hidden; }
        .modal.active { transform: translateY(0); visibility: visible; }
        button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        #modal-bg { transition: opacity 0.3s ease; }
        .tab-btn.active { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); color: #1D1D1F; font-weight: 800; }
    </style>
</head>
<body class="bg-[#FBFBFD] text-[#1D1D1F] pb-32 overflow-x-hidden">
    <!-- UI Header -->
    <header class="bg-white/90 backdrop-blur-xl p-5 sticky top-0 z-50 rounded-b-[2.5rem] flex justify-between items-center border-b border-gray-100">
        <div>
            <h1 class="text-[10px] font-black text-orange-500 tracking-[0.3em] uppercase mb-0.5">Marda Loop</h1>
            <h2 class="text-xl font-bold leading-tight tracking-tighter">BAKERY ELITE</h2>
        </div>
        <div id="weather-hub" class="flex flex-col items-end">
            <div class="flex items-center space-x-2 bg-gray-50 px-3 py-1.5 rounded-2xl border border-gray-100 min-w-[65px] justify-center" id="temp-box">
                <i class="fas fa-snowflake text-blue-400 text-[10px]" id="weather-icon"></i>
                <span id="current-temp" class="text-xs font-black">--¬∞</span>
            </div>
        </div>
    </header>

    <!-- App Tabs -->
    <nav class="p-1 flex bg-gray-100/80 m-4 rounded-2xl border border-gray-100">
        <button onclick="switchView('menu')" id="tab-menu" class="tab-btn active flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all text-gray-400">MENU</button>
        <button onclick="switchView('history')" id="tab-history" class="tab-btn flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all text-gray-400">HISTORY</button>
    </nav>

    <!-- Dynamic Views -->
    <main class="px-4" id="main-content">
        <div id="view-menu" class="grid grid-cols-2 gap-4">
            <!-- Menu items injected here -->
        </div>
        <div id="view-history" class="hidden space-y-3">
            <!-- Orders history injected here -->
        </div>
    </main>

    <!-- Cart / Details Modal -->
    <div id="modal-bg" class="fixed inset-0 bg-black/60 z-[60] hidden opacity-0" onclick="closeModals()"></div>
    
    <!-- üõí Shopping Bag Modal -->
    <div id="cart-modal" class="fixed inset-x-0 bottom-0 bg-white rounded-t-[3rem] z-[70] modal p-6 shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar">
        <div class="flex justify-between items-center mb-6 px-2">
            <h2 class="text-2xl font-black uppercase tracking-tighter">Your Bag</h2>
            <button onclick="toggleCart(false)" class="bg-gray-100 h-10 w-10 rounded-full flex items-center justify-center active:scale-90 transition-transform">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        
        <div id="cart-items-list" class="space-y-3 mb-8"></div>

        <div class="bg-gray-50 p-6 rounded-[2.5rem] space-y-3 border border-gray-100 mb-6">
            <div class="flex justify-between text-gray-500 text-sm font-bold"><span>Subtotal</span><span id="sub-price">$0.00</span></div>
            <div class="flex justify-between text-gray-400 text-xs font-medium italic"><span>GST (5%)</span><span id="tax-price">$0.00</span></div>
            <div class="flex justify-between items-end pt-3 border-t border-gray-200">
                <span class="font-black text-xl">TOTAL</span>
                <span id="final-price" class="text-2xl font-black text-orange-500">$0.00</span>
            </div>
        </div>

        <button onclick="processOrder()" id="pay-btn" class="w-full bg-[#1D1D1F] text-white py-5 rounded-[2rem] font-black text-lg shadow-xl active:scale-95 transition-all flex items-center justify-center space-x-3">
            <span id="pay-text">PAY NOW</span>
            <i id="pay-icon" class="fas fa-arrow-right text-xs"></i>
        </button>
    </div>

    <!-- üìú Order Details Modal -->
    <div id="details-modal" class="fixed inset-x-0 bottom-0 bg-white rounded-t-[3rem] z-[70] modal p-8 shadow-2xl max-h-[80vh] overflow-y-auto no-scrollbar font-sans text-sm">
        <div class="flex justify-between items-center mb-8">
            <h2 id="order-details-title" class="text-xl font-black text-orange-500">ORDER #0000</h2>
            <button onclick="closeDetails()" class="bg-gray-100 h-8 w-8 rounded-full flex items-center justify-center"><i class="fas fa-times text-gray-400"></i></button>
        </div>
        <div id="order-contents" class="space-y-4 mb-8"></div>
        <button onclick="closeDetails()" class="w-full bg-orange-50 text-orange-600 py-4 rounded-2xl font-bold uppercase tracking-widest">Close</button>
    </div>

    <!-- Bag Toggle Bar -->
    <div id="floating-cart" class="fixed bottom-8 inset-x-6 bg-[#1D1D1F] text-white p-4 rounded-[2.5rem] flex justify-between items-center hidden z-40 shadow-2xl border border-white/5 active:scale-[0.98] transition-all" onclick="toggleCart(true)">
        <div class="flex items-center space-x-4">
            <div class="relative bg-orange-500 h-11 w-11 rounded-2xl flex items-center justify-center">
                <i class="fas fa-shopping-bag text-sm"></i>
                <span id="float-count" class="absolute -top-1.5 -right-1.5 bg-white text-black text-[10px] font-black h-5 w-5 rounded-full flex items-center justify-center border-2 border-[#1D1D1F]">0</span>
            </div>
            <div>
                <p id="float-total" class="font-bold text-lg leading-none tracking-tighter">$0.00</p>
                <p class="text-[8px] text-orange-500 font-black uppercase tracking-[0.2em] mt-1">Review Bag</p>
            </div>
        </div>
        <i class="fas fa-chevron-up text-gray-600 mr-2"></i>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const menu = [
            { id: 1, name: "Gold Croissant", price: 4.50, img: "https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=400" },
            { id: 2, name: "YYC Iced Latte", price: 5.75, img: "https://images.unsplash.com/photo-1517701604599-bb29b565090c?w=400" },
            { id: 3, name: "Almond Pain", price: 5.00, img: "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=400" },
            { id: 4, name: "Marda Club", price: 12.50, img: "https://images.unsplash.com/photo-1528735602780-2552fd46c7af?w=400" },
            { id: 5, name: "Blueberry Muffin", price: 3.50, img: "https://images.unsplash.com/photo-1558401391-7899b4bd5bbf?w=400" },
            { id: 6, name: "Avocado Sourdough", price: 10.99, img: "https://images.unsplash.com/photo-1525351484163-7529414344d8?w=400" }
        ];

        let cart = {};
        let orderHistory = JSON.parse(localStorage.getItem('bakery_history')) || [];
        let isProcessing = false;

        // üå°Ô∏è RELIABLE WEATHER
        async function fetchWeather() {
            const tempEl = document.getElementById('current-temp');
            const iconEl = document.getElementById('weather-icon');
            try {
                // Fixed: Explicitly preventing caching to get fresh Calgary data
                const res = await fetch('https://wttr.in/Calgary?format=%t&u&ts=' + Date.now());
                const t = await res.text();
                const temp = parseInt(t.replace('+', ''));
                tempEl.innerText = temp + "¬∞C";
                iconEl.className = temp > 5 ? "fas fa-sun text-orange-400 text-[10px]" : "fas fa-snowflake text-blue-400 text-[10px]";
            } catch(e) { 
                tempEl.innerText = "Check App"; // Fallback to avoid stale data
            }
        }
        fetchWeather();

        function switchView(view) {
            document.getElementById('view-menu').classList.toggle('hidden', view !== 'menu');
            document.getElementById('view-history').classList.toggle('hidden', view !== 'history');
            document.getElementById('tab-menu').className = `tab-btn flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all ${view === 'menu' ? 'active' : 'text-gray-400'}`;
            document.getElementById('tab-history').className = `tab-btn flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all ${view === 'history' ? 'active' : 'text-gray-400'}`;
            if(view === 'history') renderHistory();
        }

        function toggleCart(show) {
            if(isProcessing) return;
            const modal = document.getElementById('cart-modal');
            const bg = document.getElementById('modal-bg');
            if(show) {
                renderCartRows();
                bg.classList.remove('hidden');
                modal.style.visibility = "visible";
                modal.classList.add('active');
                setTimeout(() => bg.style.opacity = "1", 10);
            } else {
                modal.classList.remove('active');
                bg.style.opacity = "0";
                setTimeout(() => {
                    bg.classList.add('hidden');
                    modal.style.visibility = "hidden";
                }, 300);
            }
        }

        function closeModals() {
            toggleCart(false);
            closeDetails();
        }

        function changeQty(id, delta) {
            if(isProcessing) return;
            cart[id] = (cart[id] || 0) + delta;
            if(cart[id] <= 0) delete cart[id];
            updateGlobalUI();
            renderCartRows();
            tg.HapticFeedback.impactOccurred('medium');
        }

        function updateGlobalUI() {
            const count = Object.values(cart).reduce((a, b) => a + b, 0);
            const subtotal = Object.keys(cart).reduce((acc, id) => acc + (menu.find(m => m.id == id).price * cart[id]), 0);
            document.getElementById('float-count').innerText = count;
            document.getElementById('float-total').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('floating-cart').classList.toggle('hidden', count === 0);
        }

        function renderCartRows() {
            const list = document.getElementById('cart-items-list');
            const subtotal = Object.keys(cart).reduce((acc, id) => {
                const item = menu.find(m => m.id == id);
                return acc + (item ? item.price * cart[id] : 0);
            }, 0);
            const gst = subtotal * 0.05;

            document.getElementById('sub-price').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax-price').innerText = `$${gst.toFixed(2)}`;
            document.getElementById('final-price').innerText = `$${(subtotal + gst).toFixed(2)}`;

            if(!Object.keys(cart).length) {
                list.innerHTML = `<div class="text-center py-12 text-gray-300 font-black uppercase tracking-widest text-[10px]">Empty Bag Policy Applied ü•Ø</div>`;
                document.getElementById('pay-btn').disabled = true;
                return;
            }
            document.getElementById('pay-btn').disabled = false;

            list.innerHTML = Object.keys(cart).map(id => {
                const item = menu.find(m => m.id == id);
                return `
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-3xl border border-gray-100">
                        <div class="flex items-center space-x-4">
                            <img src="${item.img}" class="h-12 w-12 rounded-2xl object-cover shadow-sm">
                            <div><p class="text-sm font-extrabold uppercase tracking-tighter">${item.name}</p><p class="text-[10px] text-orange-500 font-bold">$${item.price.toFixed(2)}</p></div>
                        </div>
                        <div class="flex items-center space-x-4 bg-white p-1 rounded-2xl shadow-sm ring-1 ring-black/5">
                            <button onclick="changeQty(${id},-1)" class="text-orange-500 font-black px-2 text-lg">Ôºç</button>
                            <span class="text-xs font-black min-w-[20px] text-center">${cart[id]}</span>
                            <button onclick="changeQty(${id},1)" class="text-orange-500 font-black px-2 text-lg">Ôºã</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function processOrder() {
            if(isProcessing) return;
            isProcessing = true;
            const btn = document.getElementById('pay-btn');
            document.getElementById('pay-text').innerText = "VIBE CHECKING...";
            document.getElementById('pay-icon').className = "fas fa-sync fa-spin ml-2";
            
            tg.HapticFeedback.notificationOccurred('success');

            setTimeout(() => {
                const orderData = Object.keys(cart).map(id => {
                    const item = menu.find(m => m.id == id);
                    return `${item.name} x${cart[id]}`;
                });

                const order = { 
                    id: '#'+Math.floor(Math.random()*9000+1000), 
                    date: new Date().toLocaleString(), 
                    total: document.getElementById('final-price').innerText,
                    summary: orderData.join(', ')
                };
                
                orderHistory.unshift(order);
                localStorage.setItem('bakery_history', JSON.stringify(orderHistory));
                
                document.getElementById('pay-text').innerText = "TRANSACTION ALERT!";
                document.getElementById('pay-icon').className = "fas fa-check-circle ml-2";
                btn.style.background = "#22C55E";

                setTimeout(() => {
                    cart = {};
                    updateGlobalUI();
                    toggleCart(false);
                    isProcessing = false;
                    switchView('history');
                    btn.style.background = "#1D1D1F";
                    document.getElementById('pay-text').innerText = "PAY NOW";
                    document.getElementById('pay-icon').className = "fas fa-arrow-right";
                }, 1500);
            }, 2500);
        }

        function showOrderDetails(index) {
            const order = orderHistory[index];
            const modal = document.getElementById('details-modal');
            const bg = document.getElementById('modal-bg');
            
            document.getElementById('order-details-title').innerText = `ORDER ${order.id}`;
            document.getElementById('order-contents').innerHTML = `
                <div class="space-y-4">
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Items Purchased:</p>
                    <p class="text-sm font-medium leading-relaxed">${order.summary}</p>
                    <div class="h-px bg-gray-100 w-full my-4"></div>
                    <div class="flex justify-between">
                        <span class="text-gray-400 font-bold">DATE:</span>
                        <span class="font-black">${order.date}</span>
                    </div>
                    <div class="flex justify-between text-lg border-t border-gray-100 pt-4">
                        <span class="text-gray-900 font-black">TOTAL PAID:</span>
                        <span class="text-orange-500 font-black">${order.total}</span>
                    </div>
                </div>
            `;
            
            bg.classList.remove('hidden');
            modal.style.visibility = "visible";
            modal.classList.add('active');
            setTimeout(() => bg.style.opacity = "1", 10);
        }

        function closeDetails() {
            const modal = document.getElementById('details-modal');
            const bg = document.getElementById('modal-bg');
            modal.classList.remove('active');
            bg.style.opacity = "0";
            setTimeout(() => { bg.classList.add('hidden'); modal.style.visibility = "hidden"; }, 300);
        }

        function renderHistory() {
            const list = document.getElementById('view-history');
            if(!orderHistory.length) {
                list.innerHTML = `<p class="text-center text-gray-400 text-xs py-20 italic font-medium">No past glories here...</p>`;
                return;
            }
            list.innerHTML = `<h3 class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-4 px-2">Recents</h3>` + orderHistory.map((o, idx) => `
                <div onclick="showOrderDetails(${idx})" class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-gray-100 flex justify-between items-center mb-3 active:scale-95 transition-transform cursor-pointer">
                    <div>
                        <p class="text-[9px] font-black text-orange-500 tracking-[0.1em]">${o.id}</p>
                        <p class="font-bold text-sm leading-tight mt-1 text-gray-800">Delivered</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-black text-lg">${o.total}</span>
                        <i class="fas fa-chevron-right text-[10px] text-gray-200"></i>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('view-menu').innerHTML = menu.map(i => `
            <div class="item-card bg-white p-3 rounded-[3rem] shadow-sm border border-gray-50 flex flex-col items-center">
                <img src="${i.img}" class="h-28 w-full object-cover rounded-[2.5rem] mb-3">
                <h3 class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1 text-center">${i.name}</h3>
                <p class="font-black text-lg mb-3">$${i.price.toFixed(2)}</p>
                <button onclick="changeQty(${i.id},1)" class="w-full bg-gray-50 text-orange-500 py-3.5 rounded-[1.8rem] active:bg-orange-500 active:text-white transition-all"><i class="fas fa-plus text-xs"></i></button>
            </div>
        `).join('');

        updateGlobalUI();
    </script>
</body>
</html>
